<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/style.css">
    <title>Partida</title>

</head>

<body class="bg-primary">
    <label for="nomeSala">Nome da Sala: </label>
    <input type="text" name="nomeSala" id="nomeSala" value="<%= locals.salaGame.nome %>">
    <br>
    <label for="jogador1">Jogador 1: </label>
    <input type="text" name="jogador1" id="jogador1" value="<%= locals.salaGame.jogador1 %>">
    <label for="jogador1">ID do Socket: <span id="idSocket"></span></label>
    <br>
    <label for="jogador2">Jogador 2: </label>
    <input type="text" name="jogador2" id="jogador2" value="<%= locals.salaGame.jogador2 %>">
    <label for="jogador1">ID do Socket 2: <span id="idSocket2"></span></label>
    <br>
    <label for="jogador1">Número de Jogadores: </label>
    <input type="text" name="numJogadores" id="numJogadores" value="<%= locals.salaGame.numJogadores %>">
    <label for="jogador1">ID da Sala: </label>
    <input type="text" name="idSala" id="idSala" value="<%= locals.salaGame.id %>">

    <div class="text-center mt-3">
        <canvas width="400"></canvas>
    </div>
    <div class="text-center mt-3">
        <div class="button">
            <button>Resetar Jogo</button>
        </div>
    </div>

    <h2 class="rodape text-center">Vez do Jogador: <span id="vezDoJogador"></span></h2>

    <script src="/socket.io/socket.io.js"></script>

    <script>
        const socket = io();
        let nomeJogadorNestaSala;
        let nomeJogadorConvidado;

        function getNameCookie() {
            let cookie = document.cookie;
            let indIgual = cookie.indexOf('=');
            nomeJogadorNestaSala = cookie.substring(indIgual + 1, cookie.length);
        }
        getNameCookie();

        let idSala = document.querySelector('#idSala').value;
        let nomeSala = document.querySelector('#nomeSala').value;
        let criador = document.querySelector('#jogador1').value;

        let novaSala = {
            idSala: idSala,
            nomeSala: nomeSala,
            criador: criador,
            jogador1: document.querySelector('#jogador1').value,
            jogador2: '',
            idJogador1: document.querySelector('#idSocket').innerText,
            idJogador2: '',
        };

        socket.emit('getMyIdSocket', nomeJogadorNestaSala);
        socket.on('getMyId', (idSocket) => {

            if (novaSala.criador == nomeJogadorNestaSala) {
                novaSala.idJogador1 = idSocket;
                document.querySelector('#jogador1').value = nomeJogadorNestaSala
                document.querySelector('#idSocket').innerText = idSocket;
            } else {
                novaSala.jogador2 = nomeJogadorNestaSala;
                novaSala.idJogador2 = idSocket;
                document.querySelector('#jogador2').value = nomeJogadorNestaSala;
                document.querySelector('#idSocket2').innerText = idSocket;
                socket.emit('jogador2-entrou-na-sala', novaSala);
            }
        });

        socket.on('completa-dados-jogadores', (room) => {
            alert("Recebi room!!!");
            novaSala = room;
            alert(JSON.stringify(novaSala));
            document.querySelector('#jogador1').value = novaSala.jogador1;
            document.querySelector('#idSocket').innerText = novaSala.idJogador1;
            document.querySelector('#jogador2').value = novaSala.jogador2;
            document.querySelector('#jogador2').value = novaSala.jogador2;
            document.querySelector('#numJogadores').value = 2;
            iniciarJogo();
        });

        // ============================== configuraces da partida ==============================



        // =================================== começar partida ===================================

        let canvas = document.querySelector('canvas');
        let contexto = canvas.getContext('2d');
        let ladoQuadrado = canvas.width;
        canvas.height = canvas.width;
        let vezDoJogador;

        let imagemSimbolo = new Image();
        imagemSimbolo.src = vezDoJogador == "X" ? "/images/simbolo_X.png" : "/images/simbolo_O.png";
        let tabela = [
            '', '', '', '', '', '', '', '', '',
        ];
        let cor = 'black';
        let escala = 2;

        function desenharLinha(cor, x0, y0, x, y) {
            contexto.lineWidth = 5;
            contexto.strokeStyle = cor;

            contexto.beginPath();
            contexto.moveTo(x0, y0);
            contexto.lineTo(x, y);
            contexto.stroke();
        }

        function criarAsLinhasDivisorias() {

            // Desenhe uma linha
            desenharLinha(cor, ladoQuadrado / 3, 0, ladoQuadrado / 3, ladoQuadrado);
            desenharLinha(cor, ladoQuadrado * 2 / 3, 0, ladoQuadrado * 2 / 3, ladoQuadrado);
            desenharLinha(cor, 0, ladoQuadrado / 3, ladoQuadrado, ladoQuadrado / 3);
            desenharLinha(cor, 0, ladoQuadrado * 2 / 3, ladoQuadrado, ladoQuadrado * 2 / 3);

        }

        function verificarEmQualCasaFoiClicada(mouseX, mouseY) {
            if (mouseX <= ladoQuadrado / 3) {
                if (mouseY <= ladoQuadrado / 3) {
                    return 1
                } else if (mouseY <= ladoQuadrado * 2 / 3) {
                    return 4
                } else {
                    return 7
                }
            } else if (mouseX <= ladoQuadrado * 2 / 3) {
                if (mouseY <= ladoQuadrado / 3) {
                    return 2
                } else if (mouseY <= ladoQuadrado * 2 / 3) {
                    return 5
                } else {
                    return 8
                }
            } else {
                if (mouseY <= ladoQuadrado / 3) {
                    return 3
                } else if (mouseY <= ladoQuadrado * 2 / 3) {
                    return 6
                } else {
                    return 9
                }
            }
        }

        function tentarPreencherCasa() {
            if (tabela[casaClicada - 1]) {
                alert("Esta casa já foi preenchida!")
            } else {
                desenharSimbolo(casaClicada)
                vezDoJogador = vezDoJogador == "X" ? "O" : "X"
                imagemSimbolo.src = vezDoJogador == "X" ? "/images/simbolo_X.png" : "/images/simbolo_O.png"
                tabela[casaClicada - 1] = vezDoJogador
                document.querySelector('#vezDoJogador').textContent = vezDoJogador
            }
        }

        function verificarVitoria(numCasasPreenchidas) {

            let linha = horizontal()
            let coluna = vertical()
            let diagonalP = diagonalPrincipal()
            let diagonalS = diagonalSecundaria()

            console.log(linha)
            console.log(coluna)
            console.log(diagonalP)
            console.log(diagonalS)

            if (linha[0]) {
                let vencedor = linha[2] == "X" ? "O" : "X"
                desenharVitoria(linha, "linha")
            } else if (coluna[0]) {
                let vencedor = coluna[2] == "X" ? "O" : "X"
                desenharVitoria(coluna, "coluna")
            } else if (diagonalP[0]) {
                let vencedor = diagonalP[1] == "X" ? "O" : "X"
                desenharVitoria(diagonalP, "diagonalP")
            } else if (diagonalS[0]) {
                let vencedor = diagonalS[1] == "X" ? "O" : "X"
                desenharVitoria(diagonalS, "diagonalS")
            } else if (numCasasPreenchidas == 9) {
                document.querySelector('#vezDoJogador').textContent = "Deu velha"
                canvas.removeEventListener('click', cliqueNocanvas)
            }
        }

        function horizontal() {
            let venceu = false
            let indice = 0
            let simbolo = ""
            for (let i = 0; i < 9; i += 3) {
                let a = (tabela[i] == tabela[i + 1] && tabela[i + 1] == tabela[i + 2])
                let b = (tabela[i] + tabela[i + 1] + tabela[i + 2]).length == 3
                let c = a && b
                if (c) {
                    venceu = true
                    simbolo = tabela[i]
                    break
                }
                indice++
            }
            return [venceu, indice, simbolo]
        }

        function vertical() {
            let venceu = false
            let indice = 0
            let simbolo = ""
            for (let i = 0; i < 3; i++) {
                let a = (tabela[i] == tabela[i + 3] && tabela[i + 3] == tabela[i + 6])
                let b = (tabela[i] + tabela[i + 3] + tabela[i + 6]).length == 3
                let c = a && b
                if (c) {
                    venceu = true
                    simbolo = tabela[i]
                    break
                }
                indice++
            }
            return [venceu, indice, simbolo]
        }

        function diagonalPrincipal() {
            return [
                (
                    tabela[0] == tabela[4] && tabela[4] == tabela[8] &&
                    (tabela[0] + tabela[4] + tabela[8]).length == 3
                ), tabela[0]
            ]
        }

        function diagonalSecundaria() {
            return [
                (
                    tabela[2] == tabela[4] && tabela[4] == tabela[6] &&
                    (tabela[2] + tabela[4] + tabela[6]).length == 3
                ), tabela[2]
            ]
        }

        function desenharVitoria(lista, ondeVenceu) {
            if (lista.length == 3) {
                if (ondeVenceu == "linha") {
                    // linha
                    if (lista[1] == 0) {
                        desenharLinha('#FF0000', ladoQuadrado / 10, ladoQuadrado / 6, ladoQuadrado * 9 / 10, ladoQuadrado / 6);
                    } else if (lista[1] == 1) {
                        desenharLinha('#FF0000', ladoQuadrado / 10, ladoQuadrado / 2, ladoQuadrado * 9 / 10, ladoQuadrado / 2);
                    } else {
                        desenharLinha('#FF0000', ladoQuadrado / 10, ladoQuadrado * 5 / 6, ladoQuadrado * 9 / 10, ladoQuadrado * 5 / 6);
                    }
                } else {
                    // coluna
                    if (lista[1] == 0) {
                        desenharLinha('#FF0000', ladoQuadrado / 6, ladoQuadrado / 10, ladoQuadrado / 6, ladoQuadrado * 9 / 10);
                    } else if (lista[1] == 1) {
                        desenharLinha('#FF0000', ladoQuadrado / 2, ladoQuadrado / 10, ladoQuadrado / 2, ladoQuadrado * 9 / 10);
                    } else {
                        desenharLinha('#FF0000', ladoQuadrado * 5 / 6, ladoQuadrado / 10, ladoQuadrado * 5 / 6, ladoQuadrado * 9 / 10);
                    }
                }
            } else {
                if (ondeVenceu == "diagonalP") {
                    desenharLinha('#FF0000', ladoQuadrado / 10, ladoQuadrado / 10, ladoQuadrado * 9 / 10, ladoQuadrado * 9 / 10);
                } else {
                    desenharLinha('#FF0000', ladoQuadrado * 9 / 10, ladoQuadrado / 10, ladoQuadrado / 10, ladoQuadrado * 9 / 10);
                }
            }
            canvas.removeEventListener('click', cliqueNocanvas)
            vezDoJogador = vezDoJogador == "X" ? "O" : "X"
            document.querySelector('#vezDoJogador').textContent = "Jogador " + vezDoJogador + " venceu!!!"
        }

        function cliqueNocanvas(event) {
            // Obtenha as coordenadas do clique
            var mouseX = event.clientX - canvas.getBoundingClientRect().left;
            var mouseY = event.clientY - canvas.getBoundingClientRect().top;

            // Exiba as coordenadas no console (opcional)
            console.log('Posição do clique:', mouseX, mouseY);

            casaClicada = verificarEmQualCasaFoiClicada(mouseX, mouseY);

            tentarPreencherCasa()

            let numCasasPreenchidas = 0
            let tabelaPrintada = ""
            for (let i = 1; i <= tabela.length; i++) {
                if (tabela[i] != "") {
                    numCasasPreenchidas++
                }
                tabelaPrintada += tabela[i - 1] + " ";
                if (i % 3 == 0) {
                    tabelaPrintada += "\n"
                }
            }

            console.log(tabelaPrintada)
            console.log("numCasasPreenchidas: " + numCasasPreenchidas)

            verificarVitoria(numCasasPreenchidas)
        }

        let preeencherCasa = {
            1: () => {
                let imgX = (ladoQuadrado / 6) - (imagemSimbolo.width / 4)
                let imgY = ladoQuadrado / 6 - imagemSimbolo.height / 4
                contexto.drawImage(
                    imagemSimbolo,
                    0, 0, imagemSimbolo.width, imagemSimbolo.height,
                    imgX, imgY, imagemSimbolo.width / escala, imagemSimbolo.height / escala
                )
            },
            2: () => {
                imgX = (ladoQuadrado / 2) - (imagemSimbolo.width / 4)
                imgY = ladoQuadrado / 6 - imagemSimbolo.height / 4
                contexto.drawImage(
                    imagemSimbolo,
                    0, 0, imagemSimbolo.width, imagemSimbolo.height,
                    imgX, imgY, imagemSimbolo.width / escala, imagemSimbolo.height / escala
                )
            },
            3: () => {
                imgX = (ladoQuadrado * 5 / 6) - (imagemSimbolo.width / 4)
                imgY = ladoQuadrado / 6 - imagemSimbolo.height / 4
                contexto.drawImage(
                    imagemSimbolo,
                    0, 0, imagemSimbolo.width, imagemSimbolo.height,
                    imgX, imgY, imagemSimbolo.width / escala, imagemSimbolo.height / escala
                )
            },
            4: () => {
                imgX = (ladoQuadrado / 6) - (imagemSimbolo.width / 4)
                imgY = ladoQuadrado / 6 - imagemSimbolo.height / 4 + ladoQuadrado / 3
                contexto.drawImage(
                    imagemSimbolo,
                    0, 0, imagemSimbolo.width, imagemSimbolo.height,
                    imgX, imgY, imagemSimbolo.width / escala, imagemSimbolo.height / escala
                )
            },
            5: () => {
                imgX = (ladoQuadrado / 2) - (imagemSimbolo.width / 4)
                imgY = ladoQuadrado / 6 - imagemSimbolo.height / 4 + ladoQuadrado / 3
                contexto.drawImage(
                    imagemSimbolo,
                    0, 0, imagemSimbolo.width, imagemSimbolo.height,
                    imgX, imgY, imagemSimbolo.width / escala, imagemSimbolo.height / escala
                )
            },
            6: () => {
                imgX = (ladoQuadrado * 5 / 6) - (imagemSimbolo.width / 4)
                imgY = ladoQuadrado / 6 - imagemSimbolo.height / 4 + ladoQuadrado / 3
                contexto.drawImage(
                    imagemSimbolo,
                    0, 0, imagemSimbolo.width, imagemSimbolo.height,
                    imgX, imgY, imagemSimbolo.width / escala, imagemSimbolo.height / escala
                )
            },
            7: () => {
                imgX = (ladoQuadrado / 6) - (imagemSimbolo.width / 4)
                imgY = ladoQuadrado / 6 - imagemSimbolo.height / 4 + ladoQuadrado / 1.5
                contexto.drawImage(
                    imagemSimbolo,
                    0, 0, imagemSimbolo.width, imagemSimbolo.height,
                    imgX, imgY, imagemSimbolo.width / escala, imagemSimbolo.height / escala
                )
            },
            8: () => {
                imgX = (ladoQuadrado / 2) - (imagemSimbolo.width / 4)
                imgY = ladoQuadrado / 6 - imagemSimbolo.height / 4 + ladoQuadrado / 1.5
                contexto.drawImage(
                    imagemSimbolo,
                    0, 0, imagemSimbolo.width, imagemSimbolo.height,
                    imgX, imgY, imagemSimbolo.width / escala, imagemSimbolo.height / escala
                )
            },
            9: () => {
                imgX = (ladoQuadrado * 5 / 6) - (imagemSimbolo.width / 4)
                imgY = ladoQuadrado / 6 - imagemSimbolo.height / 4 + ladoQuadrado / 1.5
                contexto.drawImage(
                    imagemSimbolo,
                    0, 0, imagemSimbolo.width, imagemSimbolo.height,
                    imgX, imgY, imagemSimbolo.width / escala, imagemSimbolo.height / escala
                )
            }
        }

        function desenharSimbolo(casaClicada) {
            let imgX, imgY
            switch (casaClicada) {
                case 1:
                    preeencherCasa[1]();
                    break
                case 2:
                    preeencherCasa[2]();
                    break
                case 3:
                    preeencherCasa[3]();
                    break
                // =======================================================
                case 4:
                    preeencherCasa[4]();
                    break
                case 5:
                    preeencherCasa[5]();
                    break
                case 6:
                    preeencherCasa[6]();
                    break
                // =======================================================
                case 7:
                    preeencherCasa[7]();
                    break
                case 8:
                    preeencherCasa[8]();
                    break
                case 9:
                    preeencherCasa[9]();
                    break
                default:
                    break
            }
        }

        function iniciarJogo() {

            criarAsLinhasDivisorias()

            // quem comeca
            document.querySelector('#vezDoJogador').textContent = vezDoJogador

            // identificar onde clicou no canvas
            canvas.addEventListener('click', cliqueNocanvas)

            // reiniciar game
            document.querySelector('button').addEventListener('click', () => {
                alert('Reiniciar partida!');
                // location.reload()
            })
        }

        // iniciarJogo();

        // ===============================================================================


    </script>
</body>

</html>
